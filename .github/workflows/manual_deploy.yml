name: ReDeploy

on:
  # Manual trigger
  workflow_dispatch:

jobs:
  deploy-prod:
    name: Deploy to Production
    runs-on: ubuntu-latest
    env:
        SSH_KEY_PATH: /tmp/ssh_key
    steps:
        - name: Checkout
          uses: actions/checkout@v2
        - name: Make envfile
          run: export | grep "secret_" | sed "s/declare -x secret_//" > .env
          env:
            secret_SENTRY_DSN: ${{ secrets.SENTRY_DSN }} 
        - run: echo "${{ secrets.PRODUCTION_SSH_KEY }}" > ${{ env.SSH_KEY_PATH }} && chmod 600 ${{ env.SSH_KEY_PATH }}
        - run: scp -o StrictHostKeyChecking=no -i ${{ env.SSH_KEY_PATH }} docker-compose.production.yml ${{ secrets.PRODUCTION_SSH_USERNAME }}@${{ secrets.PRODUCTION_SSH_HOST }}:/home/s-admin/pmpulse/docker-compose.production.yml
        - run: scp -o StrictHostKeyChecking=no -i ${{ env.SSH_KEY_PATH }} .env ${{ secrets.PRODUCTION_SSH_USERNAME }}@${{ secrets.PRODUCTION_SSH_HOST }}:/home/s-admin/pmpulse/.env
        - run: ssh -i ${{ env.SSH_KEY_PATH }} ${{ secrets.PRODUCTION_SSH_USERNAME }}@${{ secrets.PRODUCTION_SSH_HOST }} "cd /home/s-admin/pmpulse && docker compose -f docker-compose.production.yml down -v"
        - run: ssh -i ${{ env.SSH_KEY_PATH }} ${{ secrets.PRODUCTION_SSH_USERNAME }}@${{ secrets.PRODUCTION_SSH_HOST }} "cd /home/s-admin/pmpulse && docker login ghcr.io -u $GITHUB_ACTOR -p ${{ secrets.REPO_TOKEN }} && docker pull ghcr.io/toptuk/pmpulse-silohost:latest && docker pull ghcr.io/toptuk/pmpulse-webapi:latest && docker compose -f docker-compose.production.yml up -d && docker system prune --all --force"
