name: Build and Deploy

on:
  # Commented out automatic trigger on push
  # push:
  #   branches:
  #     - deploy
  
  # Manual trigger
  workflow_dispatch:

jobs:
  build-images:
    name: Build images
    runs-on: ubuntu-latest
    steps:
        - uses: actions/checkout@v2
        - run: docker login ghcr.io -u $GITHUB_ACTOR -p ${{ secrets.REPO_TOKEN }}
        - run: ./build-images.sh
        - run: |
            # Tag images for GitHub Container Registry with SHA
            docker tag pmpulse-silohost:latest ghcr.io/toptuk/pmpulse-silohost:${{ github.sha }}
            docker tag pmpulse-webapi:latest ghcr.io/toptuk/pmpulse-webapi:${{ github.sha }}
        - run: docker image push ghcr.io/toptuk/pmpulse-silohost:${{ github.sha }}
        - run: docker image push ghcr.io/toptuk/pmpulse-webapi:${{ github.sha }}