name: Build and Deploy

on:
  # Commented out automatic trigger on push
  # push:
  #   branches:
  #     - deploy
  
  # Manual trigger
  workflow_dispatch:

jobs:
  build-images:
    name: Build images
    runs-on: ubuntu-latest
    steps:
        - uses: actions/checkout@v4
        - run: chmod +x ./build-images.sh
        - run: docker login ghcr.io -u $GITHUB_ACTOR -p ${{ secrets.REPO_TOKEN }}
        - run: ./build-images.sh
        - run: |
            # Tag images for GitHub Container Registry with both SHA and latest
            docker tag pmpulse-silohost:latest ghcr.io/toptuk/pmpulse-silohost:${{ github.sha }}
            docker tag pmpulse-silohost:latest ghcr.io/toptuk/pmpulse-silohost:latest
            docker tag pmpulse-webapi:latest ghcr.io/toptuk/pmpulse-webapi:${{ github.sha }}
            docker tag pmpulse-webapi:latest ghcr.io/toptuk/pmpulse-webapi:latest
        - run: |
            # Push SHA-tagged images
            docker push ghcr.io/toptuk/pmpulse-silohost:${{ github.sha }}
            docker push ghcr.io/toptuk/pmpulse-webapi:${{ github.sha }}
        - run: |
            # Push latest-tagged images
            docker push ghcr.io/toptuk/pmpulse-silohost:latest
            docker push ghcr.io/toptuk/pmpulse-webapi:latest

  deploy-prod:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build-images
    env:
        SSH_KEY_PATH: /tmp/ssh_key
    steps:
        - name: Checkout
          uses: actions/checkout@v4
        - name: Make envfile
          run: export | grep "secret_" | sed "s/declare -x secret_//" > .env
          env:
            secret_SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
            secret_SILO_SENTRY_DSN: ${{ secrets.SILO_SENTRY_DSN }}
            secret_POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
        - run: echo "${{ secrets.PRODUCTION_SSH_KEY }}" > ${{ env.SSH_KEY_PATH }} && chmod 600 ${{ env.SSH_KEY_PATH }}
        - name: Create remote directory structure
          run: ssh -i ${{ env.SSH_KEY_PATH }} -o StrictHostKeyChecking=no ${{ secrets.PRODUCTION_SSH_USERNAME }}@${{ secrets.PRODUCTION_SSH_HOST }} "mkdir -p /home/s-admin/pmpulse/docker-entrypoint-initdb.d"
        - name: Copy docker-compose.production.yml
          run: scp -o StrictHostKeyChecking=no -i ${{ env.SSH_KEY_PATH }} docker-compose.production.yml ${{ secrets.PRODUCTION_SSH_USERNAME }}@${{ secrets.PRODUCTION_SSH_HOST }}:/home/s-admin/pmpulse/docker-compose.production.yml
        - name: Copy .env file
          run: scp -o StrictHostKeyChecking=no -i ${{ env.SSH_KEY_PATH }} .env ${{ secrets.PRODUCTION_SSH_USERNAME }}@${{ secrets.PRODUCTION_SSH_HOST }}:/home/s-admin/pmpulse/.env
        - name: Copy docker-entrypoint-initdb.d directory
          run: scp -o StrictHostKeyChecking=no -i ${{ env.SSH_KEY_PATH }} -r docker-entrypoint-initdb.d/* ${{ secrets.PRODUCTION_SSH_USERNAME }}@${{ secrets.PRODUCTION_SSH_HOST }}:/home/s-admin/pmpulse/docker-entrypoint-initdb.d/
        - run: ssh -i ${{ env.SSH_KEY_PATH }} ${{ secrets.PRODUCTION_SSH_USERNAME }}@${{ secrets.PRODUCTION_SSH_HOST }} "cd /home/s-admin/pmpulse && docker compose -f docker-compose.production.yml down -v"
        - run: ssh -i ${{ env.SSH_KEY_PATH }} ${{ secrets.PRODUCTION_SSH_USERNAME }}@${{ secrets.PRODUCTION_SSH_HOST }} "cd /home/s-admin/pmpulse && docker login ghcr.io -u $GITHUB_ACTOR -p ${{ secrets.REPO_TOKEN }} && docker pull ghcr.io/toptuk/pmpulse-silohost:latest && docker pull ghcr.io/toptuk/pmpulse-webapi:latest && docker compose -f docker-compose.production.yml up -d && docker system prune --all --force"