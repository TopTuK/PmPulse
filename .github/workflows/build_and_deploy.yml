name: Build and Deploy

on:
  # Commented out automatic trigger on push
  # push:
  #   branches:
  #     - deploy
  
  # Manual trigger
  workflow_dispatch:

jobs:
  build-images:
    name: Build images
    runs-on: ubuntu-latest
    steps:
        - uses: actions/checkout@v2
        - run: docker login ghcr.io -u $GITHUB_ACTOR -p ${{ secrets.REPO_TOKEN }}
        - run: ./build-images.sh
        - run: |
            # Tag images for GitHub Container Registry with SHA
            docker tag pmpulse-silohost:latest ghcr.io/toptuk/pmpulse-silohost:${{ github.sha }}
            docker tag pmpulse-webapi:latest ghcr.io/toptuk/pmpulse-webapi:${{ github.sha }}
        - run: docker image push ghcr.io/toptuk/pmpulse-silohost:${{ github.sha }}
        - run: docker image push ghcr.io/toptuk/pmpulse-webapi:${{ github.sha }}

  deploy-prod:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build-images
    env:
        SSH_KEY_PATH: /tmp/ssh_key
    steps:
        - name: Checkout
          uses: actions/checkout@v2
        - run: echo "${{ secrets.PRODUCTION_SSH_KEY }}" > ${{ env.SSH_KEY_PATH }} && chmod 600 ${{ env.SSH_KEY_PATH }}
        - run: scp -o StrictHostKeyChecking=no -i ${{ env.SSH_KEY_PATH }} docker-compose.production.yml ${{ secrets.PRODUCTION_SSH_USERNAME }}@${{ secrets.PRODUCTION_SSH_HOST }}:/home/s-admin/pmpulse/docker-compose.production.yml
        - run: ssh -i ${{ env.SSH_KEY_PATH }} ${{ secrets.PRODUCTION_SSH_USERNAME }}@${{ secrets.PRODUCTION_SSH_HOST }} "cd /home/s-admin/pmpulse && docker login ghcr.io -u $GITHUB_ACTOR -p ${{ secrets.REPO_TOKEN }} && docker pull ghcr.io/toptuk/pmpulse-silohost:${{ github.sha }} && docker pull ghcr.io/toptuk/pmpulse-webapi:${{ github.sha }} && docker compose -f docker-compose.production.yml up -d && docker system prune --all --force"